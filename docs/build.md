# Building the CLR Instrumentation Engine

CI/CD Builds for the CLR Instrumentation Engine are defined with yaml files (see build/yaml/ folder) which are leveraged by Azure DevOps pipeline builds.

We restrict access to initiating builds as it conducts internal processes such as signing and security checks. If you require modifications or changes to the build, you are free to update the yaml file. Please reach out to clrieowners@microsoft.com if you have any questions.

## Automated VSTS builds

Please contact clrieowners@microsoft.com to request releasing a new version. This process involves regression testing with both our internal Microsoft products as well as the products of external partners.

## Building locally

### Windows

On Windows we use MSBuild, with `.vcxproj` files to build native binaries and `.csproj` files to build the NuGet/Zip packages.
1. Install Visual Studio 2017 with the following Workloads and Components:
    - **[Workload]** .NET desktop development
    - **[Workload]** Desktop development with C++
    - **[Component]** Windows 10 SDK (10.0.14393)
    - **[Component]** Visual C++ ATL for x86 and x64
    - **[Component]** VC++ 2017 version 15.8 v14.15 Libs for Spectre (x86 and x64)
2. Open `InstrumentationEngine.sln` and `src/InstrumentationEngine.Packages.sln` in Visual Studio 2017
3. Either run "Build Solution" for a single configuration, or "Build > Batch Build..." to build all configurations (Debug|Release with x86|x64|AnyCPU).

Alternatively, you may run the script `[CLRInstrumentationEngine repo]\build.ps1` in PowerShell which conducts a local build.
|Flag|Description|
|-|-|
IncludeTests|Runs unit tests after build.
SkipBuild|Skips building the solutions. Use this with `-IncludeTests` flag to only run tests.
SkipPackaging|Skips building the package solution. This prevents generating zip files, nugets, and any other artifacts.
Release|Cause build to run with `Release` configuration. By default, build uses `Debug` configuration.
Verbose|Sets msbuild verbosity to `normal`. By default, verbosity is set to `ErrorsOnly`.

If you encounter this error:

`*.pdb was generated by the linker with /DEBUG:fastlink; compiler cannot update such PDB files; please delete it or use /Fd to specify a different PDB filename`

Please clean the solution or delete the bin folder and then try building again.

### Linux

Currently we are not ready for external partners to build for Linux.

On Linux we use CMake, with CMakeLists.txt files in each native component's root folder. Build using the script `/src/Build.sh`. Note that we have some limitations for now:
* Cannot generate InstrumentationEngine.h yet, therefore...
* It is necessary to build your corresponding flavor/architecture in Windows first so that InstrumentationEngine.h is generated by midl and placed on the expected path.
* We only support compiling for 64bit Linux.
* NuGet package building is currently not implemented.

