# Building the CLR Instrumentation Engine

CI/CD Builds for the CLR Instrumentation Engine are defined with yaml files (see build/yaml/ folder) which are leveraged by Azure DevOps
pipeline builds.

## Azure DevOps Build

Azure DevOps (previously known as Visual Studio Team Services or "VSTS") is the suite of tools and services for the end-to-end lifecycle of
software development. It provides repos to host source code, boards for task tracking, test suites and build pipelines for compiling code, and
artifact management to retain packages such as nuget feeds.

Although the CLRIE repo is hosted in GitHub, it originally was hosted privately by Microsoft and leveraged Azure DevOps pipelines to build and
release packages for internal consumption. In the spirit of Open-Source, these processes are slowly being rolled out publicly to expand and
share ownership with external partners and users.

Although the build agents and tasks are internal, the build definitions are declared in the repo in the form of yaml files.

### Yaml

[Yaml Schema Reference](https://docs.microsoft.com/azure/devops/pipelines/yaml-schema?view=azure-devops&tabs=schema)

The yaml files are located in the $RepoRoot$/build/yaml folder. The code is structured in the following manner:
* Pipelines – The top level yaml file that is queued for a given Azure DevOps build. A pipeline defines the jobs to run.
  * [ClrInstrumentationEngine-PR-Yaml](https://devdiv.visualstudio.com/DevDiv/_build?definitionId=11217) uses PR.yaml
  * [ClrInstrumentationEngine-CI-Yaml](https://devdiv.visualstudio.com/DevDiv/_build?definitionId=11310) uses CI.yaml
  * [ClrInstrumentationEngine-Signed-Yaml](https://devdiv.visualstudio.com/DevDiv/_build?definitionId=11311) uses Signed.yaml
* Jobs – A job represents the execution boundary of a set of steps on an agent machine.
  * The three high-level jobs include Binaries.yaml, Test.yaml, and Packages.yaml.
  * Jobs/Binaries.yaml and Jobs/Packages.yaml reference the corresponding files in the Windows and Linux folders for parallelization
* Steps – The task to run (eg. Nuget restore, msbuild solution, copy files).

We restrict access to running the above builds as it requires internal processes such as signing and security checks. If you require
modifications or changes to the build, you are free to update the yaml files.

Please contact clrieowners@microsoft.com regarding questions or requesting the release of a new version. This process involves regression
testing with both our internal Microsoft products as well as the products of external partners.

## Building locally

### Windows

On Windows we use MSBuild, with `.vcxproj` files to build native binaries and `.csproj` files to build the NuGet/Zip packages.
1. Install Visual Studio 2019 with the following Workloads and Components:
    - **[Workload]** .NET desktop development
    - **[Workload]** Desktop development with C++
    - **[Component]** Windows 10 SDK (10.0.18362)
    - **[Component]** Visual C++ ATL for x86 and x64
    - **[Component]** VC++ 2019 version v14.2x Libs for Spectre (x86 and x64)
2. Open `InstrumentationEngine.sln` and `src/InstrumentationEngine.Packages.sln` in Visual Studio 2019
3. Either run "Build Solution" for a single configuration, or "Build > Batch Build..." to build all configurations
(Debug|Release with x86|x64|AnyCPU).

Alternatively, you may run the script `[CLRInstrumentationEngine repo]\build.ps1` in PowerShell which conducts a local build.

|Flag|Description|
|-|-|
IncludeTests|Runs unit tests after build.
SkipBuild|Skips building the solutions. Use this with `-IncludeTests` flag to only run tests.
SkipPackaging|Skips building the package solution. This prevents generating zip files, nugets, and any other artifacts.
Release|Cause build to run with `Release` configuration. By default, build uses `Debug` configuration.
Verbose|Sets msbuild verbosity to `normal`. By default, verbosity is set to `ErrorsOnly`.

If you encounter this error:

`*.pdb was generated by the linker with /DEBUG:fastlink; compiler cannot update such PDB files; please delete it or use /Fd to specify a different PDB filename`

Please clean the solution or delete the bin folder and then try building again.

### Linux

Currently we are not ready for external partners to build for Linux.

On Linux we use CMake, with CMakeLists.txt files in each native component's root folder. Build using the script `/src/Build.sh`. Note that we
have some limitations for now:
* Cannot generate InstrumentationEngine.h yet, therefore...
* It is necessary to build your corresponding flavor/architecture in Windows first so that InstrumentationEngine.h is generated by midl and placed on the expected path.
* We only support compiling for 64bit Linux and only support specific versions of Alpine, Ubuntu, and Debian.
* NuGet package building is currently not implemented.

Since the CLRIE contains C++ code that depends on a mix of C++ standard functions (eg. wprintf) and
Windows-specific functions (eg. GetEnvironmentVariable from winbase.h), we leverage the same library
that the [dotnet Core CLR](https://github.com/dotnet/coreclr) uses to compile on Linux: the [Platform Abstraction Layer or "PAL"](https://github.com/dotnet/coreclr/blob/master/src/pal/inc/pal.h).

WARNING: If you attempt to build on Linux, you may see a CoreCLRPAL package. This package is customized to support a subset of the PAL which is used by some internal Microsoft products including the CLRIE. We offer no guarantees or warranties as to the correctness of this package and can update at our own descretion based on the needs of our products and features. We strongly encourage users to generate their own package from the dotnet Core CLR repo instead.