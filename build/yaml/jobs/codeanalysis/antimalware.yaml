# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

# Job Template: Run AntiMalware Analysis

jobs:
- job: CodeAnaysis_AntiMalware
  displayName: Code Analysis - AntiMalware

  pool:
    name: VSEngSS-MicroBuild2022-1ES

  workspace:
    clean: all

  steps:
  - checkout: self
    clean: true

  - task: DownloadBuildArtifacts@0
    displayName: Download Windows Files (Release)
    inputs:
      downloadType: single
      artifactName: binaries-windows-Release
      downloadPath: $(Build.ArtifactStagingDirectory)

  # Run AntiMalware on source
  - task: AntiMalware@4
    displayName: Run AntiMalware on Source
    inputs:
      InputType: Basic
      ScanType: CustomScan
      FileDirPath: $(Build.SourcesDirectory)
    continueOnError: true

  # Run AntiMalware on artifacts
  - task: AntiMalware@4
    displayName: Run AntiMalware on Artifacts
    inputs:
      InputType: Basic
      ScanType: CustomScan
      DisableRemediation: false
      FileDirPath: $(Build.ArtifactStagingDirectory)
    continueOnError: true

  # Publish SecurityAnalysis Logs
  - template: ../../steps/codeanalysis/publishreports.yaml
    parameters:
      ArtifactName: AntiMalware

  - template: ../../steps/codeanalysis/filebugs.yaml
    parameters:
      BuildName: AntiMalware
      Tags: CLRIEAntiMalware

  # Microbuild Cleanup
  - template: ../../steps/microbuild/cleanup.yaml
