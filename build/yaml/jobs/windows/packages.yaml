# Job Template: Build Windows Packages

parameters:
  SignType: None

jobs:
- job: Windows_Packages
  displayName: Windows Packages

  strategy:
    matrix:
      Release_x86:
        Configuration: 'Release'
        Platform: 'x86'
      Release_x64:
        Configuration: 'Release'
        Platform: 'x64'
      Release_AnyCPU:
        Configuration: 'Release'
        Platform: 'Any CPU'
      ${{ if in(parameters.SignType, '', 'None') }}:
        Debug_x86:
          Configuration: 'Debug'
          Platform: 'x86'
        Debug_x64:
          Configuration: 'Debug'
          Platform: 'x64'
        Debug_AnyCPU:
          Configuration: 'Debug'
          Platform: 'Any CPU'

  pool:
    name: VSEng-MicroBuildVS2017
    demands:
    - msbuild
    - vstest

  workspace:
    clean: outputs

  steps:
  - checkout: self
    clean: true

  - template: ../../steps/microbuild/signing.yaml
    parameters:
      SignType: ${{ parameters.SignType }}

  - template: ../../steps/windows/packages.yaml
    parameters:
      WindowsBinRoot: $(Build.ArtifactStagingDirectory)\binaries-windows-$(Configuration)

  - task: CopyFiles@2
    displayName: 'Copy Packages'
    inputs:
      SourceFolder: '$(Build.ArtifactStagingDirectory)\bin\$(Configuration)'
      Contents: |
        **\*.nupkg
        **\*.zip
        **\*.msi
        **\*.msm
        **\*.guids
      TargetFolder: '$(Build.ArtifactStagingDirectory)\packages'
      CleanTargetFolder: true
    continueOnError: true
    condition: succeededOrFailed()

  - template: ../../steps/microbuild/publishbuildartifacts.yaml
    parameters:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)\packages'
      ArtifactName: 'packages-windows-$(Configuration)'


  - template: ../../steps/microbuild/cleanup.yaml

  - template: ../../steps/microbuild/componentgovernance.yaml