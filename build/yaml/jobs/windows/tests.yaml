# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

# Job Template: Test Windows Binaries

parameters:
  IsMicroBuildInternal: false
  MatrixStrategy: {}
  TestType: 'Native'

jobs:
- job: Test_Windows_Binaries_${{ parameters.TestType }}
  displayName: Windows Tests ${{ parameters.TestType }}

  strategy:
    matrix:
      ${{ insert }}: ${{ parameters.MatrixStrategy }}

  pool:
    ${{ if eq('true', parameters.IsMicroBuildInternal) }}:
      name: VSEngSS-MicroBuild2019
      demands:
      - msbuild
      - vstest
    ${{ if not(eq('true', parameters.IsMicroBuildInternal)) }}:
      vmImage: windows-2019

  workspace:
    clean: outputs

  steps:
  - checkout: self
    clean: true

  - template: ../../steps/azuredevops/downloadbuildartifacts.yaml
    parameters:
      ArtifactName: binaries-windows-$(Configuration)

  # When running native tests, include all tests
  # from all folders recursively
  - ${{ if eq('Native', parameters.TestType) }}:
    - template: ../../steps/windows/tests.yaml
      parameters:
        Platform: $(Platform)
        TestType: ${{ parameters.TestType }}
        SubFolder: '**\'
  
  # All of the .NET tests need to be run separately
  # otherwise vstest will fallback to running
  # .NET Framework tests only. Minimize by grouping
  # by their runtime version.
  - ${{ if eq('Managed', parameters.TestType) }}:
    - template: ../../steps/windows/tests.yaml
      parameters:
        Platform: $(Platform)
        TestType: ${{ parameters.TestType }}

    - template: ../../steps/windows/tests.yaml
      parameters:
        Platform: $(Platform)
        TestType: ${{ parameters.TestType }}
        SubFolder: 'net4*\'

    - template: ../../steps/windows/tests.yaml
      parameters:
        Platform: $(Platform)
        TestType: ${{ parameters.TestType }}
        SubFolder: 'netcoreapp3.1\'
    
    - template: ../../steps/windows/tests.yaml
      parameters:
        Platform: $(Platform)
        TestType: ${{ parameters.TestType }}
        SubFolder: 'net50\'

  - ${{ if eq('true', parameters.IsMicroBuildInternal) }}:
    - template: ../../steps/microbuild/cleanup.yaml

  - template: ../../steps/azuredevops/componentgovernance.yaml