# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

# Job Template: Test Windows Binaries

parameters:
  IsMicroBuildInternal: false
  MatrixStrategy: {}

jobs:
- job: Test_Windows_Binaries
  displayName: Windows Tests

  strategy:
    matrix:
      ${{ insert }}: ${{ parameters.MatrixStrategy }}

  pool:
    ${{ if eq('true', parameters.IsMicroBuildInternal) }}:
      name: VSEngSS-MicroBuild2019
      demands:
      - msbuild
      - vstest
    ${{ if not(eq('true', parameters.IsMicroBuildInternal)) }}:
      vmImage: windows-2019

  workspace:
    clean: outputs

  steps:
  - checkout: self
    clean: true

  - task: UseDotNet@2
    displayName: Install .NET Core 3.1 Runtime
    inputs:
      packageType: 'runtime'
      version: '3.1.x'

  - task: UseDotNet@2
    displayName: Install .NET 5.0 Runtime
    inputs:
      packageType: 'runtime'
      version: '5.0.x'

  - template: ../../steps/azuredevops/downloadbuildartifacts.yaml
    parameters:
      ArtifactName: binaries-windows-$(Configuration)

  - template: ../../steps/windows/tests.yaml
    parameters:
      WindowsBinRoot: $(Build.ArtifactStagingDirectory)\binaries-windows-$(Configuration)
      Platform: $(Platform)

  - ${{ if eq('true', parameters.IsMicroBuildInternal) }}:
    - template: ../../steps/microbuild/cleanup.yaml

  - template: ../../steps/azuredevops/componentgovernance.yaml