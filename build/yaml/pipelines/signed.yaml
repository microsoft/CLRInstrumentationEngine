# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

# Build Pipeline: Signed build
# Validates:
# - binaries can be built for all platforms and Release configuration
# - packages can be built for all platforms and Release configuration

name: $(date:yyyyMMdd)$(rev:rr)

variables:
  TeamName: ClrInstrumentationEngine

resources:
  repositories:
  - repository: MicroBuildTemplate
    type: git
    name: 1ESPipelineTemplates/MicroBuildTemplate
    ref: refs/tags/release

extends:
  template: azure-pipelines/MicroBuild.1ES.Official.yml@MicroBuildTemplate
  parameters:
    pool:
      name: VSEngSS-Microbuild2022-1ES
      os: (Windows
    sdl:
      sourceAnalysisPool:
        name: VSEngSS-MicroBuild2022-1ES
        os: windows 
      binskim:
        scanOutputDirectoryOnly: true # BinSkim will complain about VC.Tools not being Spectre compliant, but we use that for builds. This toggles for BinSkim to only scan the output files/folders.
    stages:
    - stage: Build
      jobs:
      # Binaries (Windows & Linux)
      - template: ../jobs/binaries.yaml
        parameters:
          IndexSources: true
          SignType: $(SignType) # NOTE this string won't be replaced until runtime
          Configuration: Release
          IsMicroBuildInternal: true
          OneESPT: true

    - stage: Package
      jobs:
      # Packages (Windows & Linux)
      - template: ../jobs/packages.yaml
        parameters:
          SignType: $(SignType) # NOTE this string won't be replaced until runtime
          Configuration: Release
          IsMicroBuildInternal: true
          OneESPT: true

    - stage: PostPackage
      jobs:
      - template: ../jobs/postpackage.yaml
        parameters:
          OneESPT: true